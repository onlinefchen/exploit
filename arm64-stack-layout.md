## ARM64 Stack Layout

### 1. Register use in the AArch64 Procedure Call Standard

. Argument registers (X0-X7).   
. X8 is the indirect result register.   
. X29 is the frame pointer register (FP).  
. X30 is the link register (LR).  

### 2. SP is always 16 bytes alignment

#### 1. none local var
```
aarch64-linux-android-gcc -pie -fPIE test.c
 15 int test()
 16 {
 17 }
 18
 19 int main()
 20 {
 30         test();
 31         return 0;
 32 }
```
```
aarch64-linux-android-objdump -d a.out
 690:	a9bf7bfd 	stp	x29, x30, [sp,#-16]!    here SP - 16 bytes
 694:	910003fd 	mov	x29, sp
 698:	97fffffd 	bl	68c <test>
 69c:	52800000 	mov	w0, #0x0                   	// #0
 6a0:	a8c17bfd 	ldp	x29, x30, [sp],#16
 6a4:	d65f03c0 	ret
```
#### 2. with local 4 int local variable
```
 15 int test()
 16 {
 17 }
 18
 19 int main()
 20 {
 21         int i = 1;
 22         int j = 2;
 23         int k = 3;
 24         int m = 5;
 25         test();
 26         return 0;
 27 }
```
```
000000000000068c <test>:
 68c:	d65f03c0 	ret

0000000000000690 <main>:
 690:	a9be7bfd 	stp	x29, x30, [sp,#-32]!    here sp - 32 (16 add 16),放置SP和LR
 694:	910003fd 	mov	x29, sp                 新的SP归位
 698:	52800020 	mov	w0, #0x1                 	// #1
 69c:	b9001fa0 	str	w0, [x29,#28]           本地变量1
 6a0:	52800040 	mov	w0, #0x2                   	// #2
 6a4:	b9001ba0 	str	w0, [x29,#24]           本地变量2
 6a8:	52800060 	mov	w0, #0x3                   	// #3
 6ac:	b90017a0 	str	w0, [x29,#20]           本地变量3
 6b0:	528000a0 	mov	w0, #0x5                   	// #5
 6b4:	b90013a0 	str	w0, [x29,#16]           本地变量5
 6b8:	97fffff5 	bl	68c <test>
 6bc:	52800000 	mov	w0, #0x0                   	// #0
 6c0:	a8c27bfd 	ldp	x29, x30, [sp],#32
 6c4:	d65f03c0 	ret
```

#### 3. one more int variable
```
 15 int test()
 16 {
 17 }
 18
 19 int main()
 20 {
 21         int i = 1;
 22         int j = 2;
 23         int k = 3;
 24         int m = 5;
 25         int z = 6;
 26         test();
 27         return 0;
 28 }
 
000000000000068c <test>:
 68c:	d65f03c0 	ret

0000000000000690 <main>:
 690:	a9bd7bfd 	stp	x29, x30, [sp,#-48]!    here sp - 48 (16 add 16 add 16)
 694:	910003fd 	mov	x29, sp
 698:	52800020 	mov	w0, #0x1                   	// #1
 69c:	b9002fa0 	str	w0, [x29,#44]           从高低往低地址使用，从28变到了44
 6a0:	52800040 	mov	w0, #0x2                   	// #2
 6a4:	b9002ba0 	str	w0, [x29,#40]
 6a8:	52800060 	mov	w0, #0x3                   	// #3
 6ac:	b90027a0 	str	w0, [x29,#36]
 6b0:	528000a0 	mov	w0, #0x5                   	// #5
 6b4:	b90023a0 	str	w0, [x29,#32]
 6b8:	528000c0 	mov	w0, #0x6                   	// #6
 6bc:	b9001fa0 	str	w0, [x29,#28]           这里只用到了偏移28，从16到28中间的12（16 - 4）没使用，用做padding
 6c0:	97fffff3 	bl	68c <test>
 6c4:	52800000 	mov	w0, #0x0                   	// #0
 6c8:	a8c37bfd 	ldp	x29, x30, [sp],#48
 6cc:	d65f03c0 	ret
```

```
+-------------------------------------------------------------------------------------------+
|   stack layout                                                                            |
|                                                                                           |
|                                                                                           |
|                                                                                           |
|                                                                                           |
|                      0    +-------------------------------------+                         |
|                           |                                     |                         |
|                      4    +---------test: SP 8 BYTES------------+                         |
|                           |                                     |                         |
|                      8    +-------------------------------------+                         |
|                           |                                     |                         |
|                      12   +---------test: LR 8 BYTES------------+                         |
|                           |                                     |                         |
|                      16   +-------------------------------------+                         |
|                           |         input param size 4 BYTES    |                         |
|                      20   +-------------------------------------+                         |
|                           |         input param data 4 BYTES    |                         |
|                      24   +-------------------------------------+                         |
|                           |                                     |                         |
|                      28   +-------------------------------------+                         |
|                           |                                     |                         |
|                      32   +-------------------------------------+                         |
|                           |                                     |                         |
|                      36   +-------------------------------------+                         |
|                           |                                     |                         |
|                      40   +-------------------------------------+                         |
|                           |                                     |                         |
|                      44   +--                               ----+                         |
|                           |                                     |                         |
|                      48   +--  local var local[] 16BYTES    ----+                         |
|                           |                                     |                         |
|                      52   +--                               ----+                         |
|                           |                                     |                         |
|                      56   +-------------------------------------+                         |
|                           |      local var j = 2                |                         |
|                      60   +-------------------------------------+                         |
|                           |      local var i = 1                |                         |
|                      64   +-------------------------------------+                         |
|                           |                                     |                         |
|                       4   +------bar: SP 8 BYTES----------------+                         |
|                           |                                     |                         |
|                       8   +-------------------------------------+                         |
|                           |                                     |                         |
|                      12   +------bar: LR 8 BYTES----------------+                         |
|                           |                                     |                         |
|                      16   +-------------------------------------+                         |
|                           |                                     |                         |
|                           +-------------------------------------+                         |
|                           |                                     |                         |
|                           |                                     |                         |
|                           |                                     |                         |
|                           |                                     |                         |
|                           v                                     v                         |
|                                                                                           |
|                                                                                           |
+-------------------------------------------------------------------------------------------+

```



```
  5 void func1()
  6 {
  7         printf("hello world!\n");
  8 }
  9
 10 int test(void *data, int size)
 11 {
 12         int i = 1;
 13         char local[16];
 14         int j = 2;
 15         printf("%lx\n", *(local + 32));
 16         /*memcpy(local + 32, data, 8);*/
 17         memset(local + 32, 0x5a, 8);
 18         printf("%lx\n", *(local + 32));
 19 }
 20
 21 int bar()
 22 {
 23         test(func1, 1);
 24 }
 25
 26 int main()
 27 {
 28         bar();
 29         printf("end of main\n");
 30         return 0;
 31 }
 
ABI: 'arm64'
pid: 3140, tid: 3140, name: a.out  >>> ./a.out <<<
signal 7 (SIGBUS), code 1 (BUS_ADRALN), fault addr 0x5a5a5a5a5a5a5a
    x0   0000000000000003  x1   0000000000000000  x2   0000000000000003  x3   00000001000007c0
    x4   00000001000007dc  x5   0000007fb782f003  x6   000000000000000a  x7   000000000000000a
    x8   3e71f1c9a64c8fcb  x9   3e71f1c9a64c8fcb  x10  0000000000004001  x11  0000000000000000
    x12  0000007fb7dcc080  x13  00000000fffffffd  x14  0000000000000000  x15  0000000000000002
    x16  0000007fb7dea2b0  x17  0000007fb7d873fc  x18  0000000028fc7761  x19  00000001000007a0
    x20  0000007ffffff9c8  x21  0000000000000001  x22  0000007ffffff9d8  x23  0000000000000000
    x24  0000000000000000  x25  0000000000000000  x26  0000000000000000  x27  0000000000000000
    x28  0000000000000000  x29  0000007ffffff950  x30  5a5a5a5a5a5a5a5a
    sp   0000007ffffff950  pc   005a5a5a5a5a5a5a  pstate 0000000060000000
    v0   0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a  v1   6f77206f6c6c656800000000d65f03c0
    v2   000000000a786c250000000021646c72  v3   00000000000000000000000000000000
    v4   00000000400000000000000000000000  v5   40100401401004014010040140100401
    v6   00400000000000000040000000000000  v7   80200802802008028020080280200802
    v8   00000000000000000000000000000000  v9   00000000000000000000000000000000
    v10  00000000000000000000000000000000  v11  00000000000000000000000000000000
    v12  00000000000000000000000000000000  v13  00000000000000000000000000000000
    v14  00000000000000000000000000000000  v15  00000000000000000000000000000000
    v16  40100401401004014010040140100401  v17  400400041000000044041000aaaaaaaa
    v18  40000400000004000010000000000000  v19  00000000000000000000000000000000
    v20  00000000000000000000000000000000  v21  00000000000000000000000000000000
    v22  00000000000000000000000000000000  v23  00000000000000000000000000000000
    v24  00000000000000000000000000000000  v25  00000000000000000000000000000000
    v26  00000000000000000000000000000000  v27  00000000000000000000000000000000
    v28  00000000000000000000000000000000  v29  00000000000000000000000000000000
    v30  00000000000000000000000000000000  v31  00000000000000000000000000000000
    fpsr 00000000  fpcr 00000000
MISMATCH: This unwind is different.
MISMATCH: No frames in new backtrace.

backtrace:
    #00 pc 005a5a5a5a5a5a5a  <unknown>
    #01 pc 5a5a5a5a5a5a5a56  <unknown>
```


```
  5 void func1()
  6 {
  7         printf("hello world!\n");
  8 }
  9
 10 int test(void *data, int size)
 11 {
 12         int i = 1;
 13         char local[16];
 14         int j = 2;
 15         printf("%lx\n", *(local + 32));
 16         memcpy(local + 32, data, 8);
 17         printf("%lx\n", *(local + 32));
 18 }
 19
 20 int bar()
 21 {
 22         test(func1, 1);
 23 }
 24
 25 int main()
 26 {
 27         bar();
 28         printf("end of main\n");
 29         return 0;
 30 }
 
135|hikey960:/data # ./a.out
ac
fd
Bus error

*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
Build fingerprint: 'Android/hikey960/hikey960:O/NYC/230:userdebug/test-keys'
Revision: '0'
ABI: 'arm64'
pid: 3152, tid: 3152, name: a.out  >>> ./a.out <<<
signal 7 (SIGBUS), code 1 (BUS_ADRALN), fault addr 0x3fda9bf7bfd
    x0   0000000000000003  x1   0000000000000000  x2   0000000000000003  x3   00000001000007c0
    x4   00000001000007dc  x5   0000007fb782f003  x6   000000000000000a  x7   000000000000000a
    x8   20115b7dfb73d327  x9   20115b7dfb73d327  x10  0000000000004001  x11  0000000000000000
    x12  0000007fb7d86080  x13  00000000fffffffd  x14  0000000000000000  x15  0000000000000002
    x16  0000007fb7da42b0  x17  0000007fb7d413fc  x18  00000000866a2b03  x19  00000001000007a0
    x20  0000007ffffff9c8  x21  0000000000000001  x22  0000007ffffff9d8  x23  0000000000000000
    x24  0000000000000000  x25  0000000000000000  x26  0000000000000000  x27  0000000000000000
    x28  0000000000000000  x29  0000007ffffff950  x30  910003fda9bf7bfd
    sp   0000007ffffff950  pc   000003fda9bf7bfd  pstate 0000000060000000
    v0   0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a  v1   6f77206f6c6c656800000000d65f03c0
    v2   000000000a786c250000000021646c72  v3   00000000000000000000000000000000
    v4   00000000400000000000000000000000  v5   40100401401004014010040140100401
    v6   00400000000000000040000000000000  v7   80200802802008028020080280200802
    v8   00000000000000000000000000000000  v9   00000000000000000000000000000000
    v10  00000000000000000000000000000000  v11  00000000000000000000000000000000
    v12  00000000000000000000000000000000  v13  00000000000000000000000000000000
    v14  00000000000000000000000000000000  v15  00000000000000000000000000000000
    v16  40100401401004014010040140100401  v17  400400041000000044041000aaaaaaaa
    v18  40000400000004000010000000000000  v19  00000000000000000000000000000000
    v20  00000000000000000000000000000000  v21  00000000000000000000000000000000
    v22  00000000000000000000000000000000  v23  00000000000000000000000000000000
    v24  00000000000000000000000000000000  v25  00000000000000000000000000000000
    v26  00000000000000000000000000000000  v27  00000000000000000000000000000000
    v28  00000000000000000000000000000000  v29  00000000000000000000000000000000
    v30  00000000000000000000000000000000  v31  00000000000000000000000000000000
    fpsr 00000000  fpcr 00000000
MISMATCH: This unwind is different.
MISMATCH: No frames in new backtrace.

backtrace:
    #00 pc 000003fda9bf7bfd  <unknown>
    #01 pc 910003fda9bf7bf9  <unknown>
```


```
 14 void func1()
 15 {
 16         printf("hello world\n");
 17 }
 18
 19 long local_data = func1;
 20
 21 int test(void *data, int size)
 22 {
 23         int i = 1;
 24         char local[16];
 25         int j = 2;
 26         printf("%lx %lx\n", *(long *)(local + 32), func1);
 27         memcpy(local + 32, data, 8);
 28         printf("%lx\n", *(long *)(local + 32));
 29 }
 30
 31 int bar()
 32 {
 33         test(&local_data, 1);
 34 }
 35
 36 int main()
 37 {
 38         bar();
 39         printf("end of main\n");
 40         return 0;
 41 }
 
 puck@puckdeMacBook-Pro:~/code/test$ adb push a.out data
a.out: 1 file pushed. 0.3 MB/s (7784 bytes in 0.023s)
puck@puckdeMacBook-Pro:~/code/test$

135|hikey960:/data # ./a.out
1000007d8 100000718
100000718
hello world!
hello world!
hello world!
hello world!
```

#### kernel exploit
```
[   30.987963] Internal error: Attempting to execute userspace memory: 8600000f [#1] PREEMPT SMP
[   30.996636] CPU: 3 PID: 3150 Comm: kernel_exploit Tainted: G S              4.9.59-02778-g5f8a978bcb38-dirty #33
[   31.006970] Hardware name: HiKey960 (DT)
[   31.010951] task: ffffffc06f319100 task.stack: ffffffc0b43fc000
[   31.016965] PC is at 0x62bbdbfd10
[   31.020329] LR is at 0x62bbdbfd10
[   31.023690] pc : [<00000062bbdbfd10>] lr : [<00000062bbdbfd10>] pstate: 90000145
[   31.031202] sp : ffffffc0b43ffe30
[   31.034561] x29: ffffffc0b43ffe30 x28: ffffffc0b43fc000 
[   31.039961] x27: ffffff8008b62000 x26: 0000000000000040 
[   31.045358] x25: 0000000000000123 x24: 0000000000000015 
[   31.050755] x23: 0000007db562f400 x22: ffffffc0b43ffeb8 
[   31.056149] x21: 0000000000000000 x20: ffffffc092addf00 
[   31.061545] x19: 4e4728203a434347 x18: 000000001e2e3282 
[   31.066940] x17: 0000007db5aae300 x16: ffffff80081e54b8 
[   31.072334] x15: 000000000000000a x14: 0000000000000000 
[   31.077730] x13: 000000000000000f x12: 00000000000003d7 
[   31.083122] x11: 0000000000000006 x10: 00000000000003d8 
[   31.088516] x9 : 0000000000000006 x8 : ffffff8008d6ff48 
[   31.093910] x7 : 0000000000000006 x6 : ffffff8008fb4719 
[   31.099303] x5 : 0000000000000003 x4 : ffffffc0be144090 
[   31.104697] x3 : 0000000000000001 x2 : ffffffc0b55a1264 
[   31.110093] x1 : 0000000000000000 x0 : 0000000000000002 
[   31.115490] 
[   31.115490] SP: 0xffffffc0b43ffdb0:
[   31.120535] fdb0 [   31.122307]  b43ffeb8


hikey960:/data/local/tmp # ./kernel_exploit
hello world!
prepare_kernel_cred 0
62bbdbfd10 62bbdbfd10 local data 62bbdbfd10 62bbdd1008


```

### 修改cred

```

```

### ROP攻击

代码复用技术，攻击从已有的代码中提取片段执行，这些代码片段往往以ret结尾，然后通过ret衔接各个片段

例如：

```
/*
 * rop read
 * ffffffc000300060:       f9405440        ldr     x0, [x2,#168]
 * ffffffc000300064:       d65f03c0        ret
 */
 读取x2偏移168到x0，稍加改造即可构造出一个任意地址读的函数
```

```
/*
 ＊　rop write
 * ffffffc000671a58:       b9000041        str     w1, [x2]
 * ffffffc000671a5c:       d65f03c0        ret
 */
 读取w1到x2，可以跳转到上面片段，得到一个任意地址写的函数
```

而且内核中这样的函数，非常之多

```
objdump vmlinux -d vm.s
   13443 c_next:
   13444 ffffff800808c958:       41 00 40 f9     ldr             x1, [x2]
   13445 ffffff800808c95c:       00 00 80 d2     mov     x0, #0
   13446 ffffff800808c960:       21 04 00 91     add     x1, x1, #1
   13447 ffffff800808c964:       41 00 00 f9     str             x1, [x2]
   13448 ffffff800808c968:       c0 03 5f d6     ret
   
      42301 reset_wcr:
   42302 ffffff80080a7870:       22 18 80 b9     ldrsw   x2, [x1, #24]
   42303 ffffff80080a7874:       21 10 40 f9     ldr     x1, [x1, #32]
   42304 ffffff80080a7878:       00 0c 02 8b     add     x0, x0, x2, lsl #3
   42305 ffffff80080a787c:       01 94 04 f9     str     x1, [x0, #2344]
   42306 ffffff80080a7880:       c0 03 5f d6     ret
   42307
   42308 reset_amair_el1:
   42309 ffffff80080a7884:       01 a3 38 d5     mrs     x1, AMAIR_EL1
   42310 ffffff80080a7888:       01 b4 02 f9     str     x1, [x0, #1384]
   42311 ffffff80080a788c:       c0 03 5f d6     ret
   
   
   
   
   17815 perf_reg_value:
   17816 ffffff8008090a80:       3f 80 00 71     cmp             w1, #32
   17843 ffffff8008090aec:       00 34 40 f9     ldr     x0, [x0, #104]
   17844 ffffff8008090af0:       c0 03 5f d6     ret
   
 148147 pm_qos_read_value:
  148148
  148149 ffffff800810b840:       00 10 40 b9     ldr     w0, [x0, #16]
  148150 ffffff800810b844:       c0 03 5f d6     ret
  
  
   1300029 uart_console_device:
 1300030 ffffff8008550684:       02 24 40 f9     ldr     x2, [x0, #72]
 1300031 ffffff8008550688:       00 84 c0 79     ldrsh   w0, [x0, #66]
 1300032 ffffff800855068c:       20 00 00 b9     str             w0, [x1]
 1300033 ffffff8008550690:       40 1c 40 f9     ldr     x0, [x2, #56]
 1300034 ffffff8008550694:       c0 03 5f d6     ret
 1300035
 
 
  1219233 pci_mcfg_lookup:
 1219234 ffffff80085044d4:       22 52 00 f0     adrp    x2, #10776576
 1219235 ffffff80085044d8:       00 3c 00 53     uxth    w0, w0
 1219236 ffffff80085044dc:       44 c0 1a 91     add     x4, x2, #1712
 1219237 ffffff80085044e0:       42 58 43 f9     ldr     x2, [x2, #1712]
 1219238 ffffff80085044e4:       5f 00 04 eb     cmp             x2, x4
 1219239 ffffff80085044e8:       a1 00 00 54     b.ne    #20
 1219240 ffffff80085044ec:       11 00 00 14     b       #68
 1219241 ffffff80085044f0:       42 00 40 f9     ldr             x2, [x2]
 1219242 ffffff80085044f4:       5f 00 04 eb     cmp             x2, x4
 1219243 ffffff80085044f8:       c0 01 00 54     b.eq    #56
 1219244 ffffff80085044fc:       43 30 40 79     ldrh    w3, [x2, #24]
 1219245 ffffff8008504500:       7f 00 00 6b     cmp             w3, w0
 1219246 ffffff8008504504:       61 ff ff 54     b.ne    #-20
 1219247 ffffff8008504508:       45 68 40 39     ldrb    w5, [x2, #26]
 1219248 ffffff800850450c:       23 00 40 f9     ldr             x3, [x1]
 1219249 ffffff8008504510:       bf 00 03 eb     cmp             x5, x3
 1219250 ffffff8008504514:       e1 fe ff 54     b.ne    #-36
 1219251 ffffff8008504518:       45 6c 40 39     ldrb    w5, [x2, #27]
 1219252 ffffff800850451c:       23 04 40 f9     ldr     x3, [x1, #8]
 1219253 ffffff8008504520:       bf 00 03 eb     cmp             x5, x3
 1219254 ffffff8008504524:       63 fe ff 54     b.lo    #-52
 1219255 ffffff8008504528:       40 08 40 f9     ldr     x0, [x2, #16]
 1219256 ffffff800850452c:       c0 03 5f d6     ret
 1219257 ffffff8008504530:       00 00 80 d2     mov     x0, #0
 1219258 ffffff8008504534:       c0 03 5f d6     ret
 1219259
 
  1145445 pci_irq_get_affinity:

 1145483 ffffff80084bebd8:       40 18 40 f9     ldr     x0, [x2, #48]
 1145484 ffffff80084bebdc:       c0 03 5f d6     ret
 
 pci_bus_resource_n：
  1114349 ffffff80084a1a18:       40 08 40 f9     ldr     x0, [x2, #16]
 1114350 ffffff80084a1a1c:       c0 03 5f d6     ret
 
 2978249 cpuidle_sysfs_setup:
2978250 ffffff8008ea2910:       e2 0e 00 f0     adrp    x2, #1961984
2978251 ffffff8008ea2914:       21 00 80 52     mov     w1, #1
2978252 ffffff8008ea2918:       e0 03 01 2a     mov      w0, w1
2978253 ffffff8008ea291c:       41 d8 0b b9     str     w1, [x2, #3032]
2978254 ffffff8008ea2920:       c0 03 5f d6     ret

  70614 ffffff80080c2ce8 <do_proc_dointvec_conv>:
  70615 ffffff80080c2ce8:       34000163        cbz     w3, ffffff80080c2d14 <do_proc_dointvec_conv+0x2c>
  70616 ffffff80080c2cec:       39400000        ldrb    w0, [x0]
  70617 ffffff80080c2cf0:       34000200        cbz     w0, ffffff80080c2d30 <do_proc_dointvec_conv+0x48>
  70618 ffffff80080c2cf4:       f9400021        ldr     x1, [x1]
  70619 ffffff80080c2cf8:       d2b00000        mov     x0, #0x80000000                 // #2147483648
  70620 ffffff80080c2cfc:       eb00003f        cmp     x1, x0
  70621 ffffff80080c2d00:       54000348        b.hi    ffffff80080c2d68 <do_proc_dointvec_conv+0x80>
  70622 ffffff80080c2d04:       4b0103e1        neg     w1, w1
  70623 ffffff80080c2d08:       52800000        mov     w0, #0x0                        // #0
  70624 ffffff80080c2d0c:       b9000041        str     w1, [x2]
  70625 ffffff80080c2d10:       d65f03c0        ret
```

### 自定义系统调用

```
aosp/bionic$ vi libc/arch-arm64/bionic/syscall.S
ENTRY(syscall)
    /* Move syscall No. from x0 to x8 */
    mov     x8, x0
    /* Move syscall parameters from x1 thru x6 to x0 thru x5 */
    mov     x0, x1
    mov     x1, x2
    mov     x2, x3
    mov     x3, x4
    mov     x4, x5
    mov     x5, x6
    svc     #0

    /* check if syscall returned successfully */
    cmn     x0, #(MAX_ERRNO + 1)
    cneg    x0, x0, hi
    b.hi    __set_errno_internal

    ret
END(syscall)
默认的syscall只返回0或者-1
```

```
ENTRY(eabi_syscall)
        mov     x8, x0
        mov     x0, x1
        mov     x1, x2
        mov     x2, x3
        mov     x3, x4
        mov     x4, x5
        mov     x5, x6
        svc     #0x0
        ret
END(eabi_syscall
```

修改内核态ops为userspace的function，进一步修改为rop的code





不可执行

```
425 static void __init map_kernel(pgd_t *pgd)
426 {
427         static struct vm_struct vmlinux_text, vmlinux_rodata, vmlinux_init, vmlinux_data;
428
429         map_kernel_segment(pgd, _text, _etext, PAGE_KERNEL_EXEC, &vmlinux_text);
430         map_kernel_segment(pgd, __start_rodata, __init_begin, PAGE_KERNEL, &vmlinux_rodata);
431         map_kernel_segment(pgd, __init_begin, __init_end, PAGE_KERNEL_EXEC,
432                            &vmlinux_init);
433         map_kernel_segment(pgd, _data, _end, PAGE_KERNEL, &vmlinux_data);
434

 52 #define PAGE_KERNEL             __pgprot(_PAGE_DEFAULT | PTE_PXN | PTE_UXN | PTE_DIRTY | PTE_WRITE)
 53 #define PAGE_KERNEL_RO          __pgprot(_PAGE_DEFAULT | PTE_PXN | PTE_UXN | PTE_DIRTY | PTE_RDONLY)
 54 #define PAGE_KERNEL_ROX         __pgprot(_PAGE_DEFAULT | PTE_UXN | PTE_DIRTY | PTE_RDONLY)
 55 #define PAGE_KERNEL_EXEC        __pgprot(_PAGE_DEFAULT | PTE_UXN | PTE_DIRTY | PTE_WRITE)
 56 #define PAGE_KERNEL_EXEC_CONT   __pgprot(_PAGE_DEFAULT | PTE_UXN | PTE_DIRTY | PTE_WRITE | PTE_CONT)
 
 
 
 PTE_UXN  userspace 不可执行
 PTE_PXN  kernelspace 不可执行，特权不可执行,el1模式
```

```
hikey960:/data/local/tmp $ ./kernel_exploit
val deadbeefdeadbeaf
hikey960:/data/local/tmp $
```



